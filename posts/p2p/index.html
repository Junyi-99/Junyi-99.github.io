<!doctype html><html lang=en-us data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>P2P 技术 - Junyi&rsquo;s Lab</title><meta name=description content="本文主要记录自己学习的 P2P 技术
在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别"><link rel=icon type=image/x-icon href=https://www.junyi.dev/favicon.ico><link rel=apple-touch-icon-precomposed href=https://www.junyi.dev/favicon.png><link rel=stylesheet href=https://www.junyi.dev/css/style.min.5aca35955b4a4a2b3987b33115c6840f82dd4fb76a33d9d54ec059a3c019dd8c.css integrity="sha256-Wso1lVtKSis5h7MxFcaED4LdT7dqM9nVTsBZo8AZ3Yw="><script src=https://www.junyi.dev/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="P2P 技术"><meta property="og:description" content="本文主要记录自己学习的 P2P 技术
在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别"><meta property="og:type" content="article"><meta property="og:url" content="https://www.junyi.dev/posts/p2p/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-26T13:06:35+08:00"><meta property="article:modified_time" content="2020-06-26T13:06:35+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="P2P 技术"><meta name=twitter:description content="本文主要记录自己学习的 P2P 技术
在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别"></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/>Junyi's Lab</a></h1><ul class=social-icons><li><a href=https://github.com/Junyi-99 title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li></ul></div><nav><a href=https://www.junyi.dev/ title>Home</a>
<a href=https://www.junyi.dev/tags/ title>Tags</a>
<a href=https://www.junyi.dev/posts/ title>Archive</a>
<a href=https://www.junyi.dev/about/ title>About</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">P2P 技术</h1></header></div><div class="content e-content"><p>本文主要记录自己学习的 P2P 技术</p><p>在这篇文章里，主要区分了各种 NAT 的类型，包括全锥形、地址限制锥形、端口限制锥形的内容和区别</p><h1 id=网络地址转换-nat-network-address-translation>网络地址转换 NAT (Network Address Translation)
<span><a href=#%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2-nat-network-address-translation><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><h2 id=基本网络地址转换-basic-nat>基本网络地址转换 Basic NAT
<span><a href=#%e5%9f%ba%e6%9c%ac%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e8%bd%ac%e6%8d%a2-basic-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>简单来讲，就是直接把内部 IP 翻译成外部 IP，这种转换技术受限于对外地址的数量，是 IP 到 IP 的转换（端口不换）</p><p>需要了解的名词有：</p><ul><li>SNAT：源地址转换</li><li>DNAT：目标地址转换</li></ul><p>以只有一个对外地址举例，如果 ClientA 和 ClientB 同时访问同一个 Web Server，那么当 NAT Gatway 收到这个 Web Server 响应包的时候，就无法判断将数据包转发给哪台客户机。</p><p>于是就有了我们接下来要介绍的 NAPT 技术</p><h2 id=网络地址端口转换-napt>网络地址端口转换 NAPT
<span><a href=#%e7%bd%91%e7%bb%9c%e5%9c%b0%e5%9d%80%e7%ab%af%e5%8f%a3%e8%bd%ac%e6%8d%a2-napt><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>先明确几个概念：</p><p>内网主机拥有的网络地址：<code>(LocalIP:LocalPort)</code></p><p>经由 NAT 转换后的网络地址：<code>(PublicIP:PublicPort)</code></p><p>外网主机拥有的网络地址：<code>(RemoteIP:RemotePort)</code></p><p>对<code>源端口</code>和<code>目标端口</code>同时进行转换。这样就可以让<code>一个公网IP</code>满足<code>多个后端主机</code>同时访问外部网络。比如家庭宽带。</p><p>这项技术最为常见，它检测并修改出入数据包的<strong>IP 地址</strong>和<strong>端口号</strong>，从而允许多个内网主机共享同一个公网 IP 地址</p><p>NAT 分为 <code>锥形NAT</code> 和 <code>对称型NAT</code></p><h1 id=锥形-nat>锥形 NAT
<span><a href=#%e9%94%a5%e5%bd%a2-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p><strong>同一个内部主机的地址和端口，无论目的地址是否相同，NAT 都将它转换成同一个外部地址和端口。</strong></p><p>192.168.1.2:8000 访问 Baidu.com:80 和 google.com:80 时，经由 NAT 转换，内部的 192.168.1.2:8000 都会被转化成 1.2.3.4:5000，baidu 看到的是 5000 端口，谷歌看到的也是</p><p>192.168.1.2:<strong>8001</strong> 访问 baidu.com:80 和 google.com:80 时，经由 NAT 转换，内部的 192.168.1.2:8001 都会变成 1.2.3.4:<strong>5001</strong>，baidu 看到的是 <strong>5001</strong> 端口，google 看到的也是。</p><p>懂了吗，这就是锥形的由来</p><h1 id=全锥形-nat-full-cone-nat>全锥形 NAT （Full Cone NAT）
<span><a href=#%e5%85%a8%e9%94%a5%e5%bd%a2-nat-full-cone-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>内向外：<code>(特定本地IP:特定本地端口)</code> –> <code>(固定映射IP:固定映射端口)</code> –> <code>(特定远端IP:特定远端端口)</code></p><p>建立 Full Cone NAT 转换后</p><p>外向内：<code>(特定本地IP:特定本地端口)</code> &lt;– <code>(固定映射IP:固定映射端口)</code> &lt;– <code>(任意远端IP:任意端口)</code></p><p>当内部主机向外发送请求时，NAT 网关会打开一个端口创建一个公网映射，形成一个 IP 端口元组，然后会将传入这个端口的数据全部转发给内部主机。<strong>一旦映射建立，那么任意一台主机，只要给映射出来的公网 IP 和端口发送数据，就可以直接到达后端服务</strong>：</p><p>也就是，内部主机以相同的 <code>(LocalIP:LocalPort)</code> 对 2 个不同的 <code>(RemoteIP:RemotePort)</code> 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，<strong>任意一台主机都可以给 <code>(PublicIP:PublicPort)</code> 发送数据</strong>。</p><h1 id=地址限制锥形-nat-address-restricted-cone-nat>地址限制锥形 NAT （Address Restricted Cone NAT）
<span><a href=#%e5%9c%b0%e5%9d%80%e9%99%90%e5%88%b6%e9%94%a5%e5%bd%a2-nat-address-restricted-cone-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>远端 IP 地址受限，远端端口无所谓</p><p>内向外：<code>(特定本地IP:特定本地端口)</code> –> <code>(固定映射IP:固定映射端口)</code> –> <code>(特定远端IP:特定远端端口)</code></p><p>建立 Address Restricted Cone NAT 转换后</p><p>外向内：<code>(特定本地IP:特定本地端口)</code> &lt;– <code>(固定映射IP:固定映射端口)</code> &lt;– <code>(特定远端IP:任意端口)</code></p><p>（注意这里变成了 <strong>任意</strong>端口）</p><p>我更喜欢它的英文形式，中文翻译的很不恰当。英文叫<strong>地址受限的锥形NAT</strong>。当内部主机向外发送请求时，NAT 网关会打开一个端口创建一个公网映射，<strong>同时记录外网的 IP 地址</strong>。一旦映射建立，<strong>只有被记录的 IP 地址给映射出来的公网 IP 和端口发送数据，才可以到达后端服务，其他 IP 地址发送给 NAT 网关的，将会被丢弃。</strong></p><p>也就是，内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，同时，也只有这 2 个 RemoteIP 可以给 (PublicIP: PublicPort) 发送数据（因为先由内向外发过），这两个 RemoteIP 的 RemotePort 可以是任意的</p><h1 id=端口限制锥形-natport-restricted-cone-nat>端口限制锥形 NAT（Port Restricted Cone NAT）
<span><a href=#%e7%ab%af%e5%8f%a3%e9%99%90%e5%88%b6%e9%94%a5%e5%bd%a2-natport-restricted-cone-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>远端 IP 地址和端口都受限，且只有内部主机向外发送过消息才可以建立。</p><p>一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</p><p>内向外：(特定本地IP:特定本地端口) –>(固定映射IP:固定映射端口) –> (特定远端IP:特定远端端口)</p><p>建立 Port Restricted Cone NAT 转换后</p><p>外向内：(特定本地IP:特定本地端口) &lt;– (固定映射IP:固定映射端口) &lt;– (特定远端IP:特定端口)</p><p>（注意这里变成了 <strong>特定</strong>端口）</p><p>这种模式同时记录<strong>内部主机的 IP 和端口</strong>和<strong>外部主机的 IP 和端口</strong>，也就是形成了一种绑定关系。</p><p>与 Address Restricted Cone NAT 的区别是， Address Restricted Cone NAT 记录的只有外网主机的 IP，不记录端口，那个外网主机的随便一个端口给内网主机发送数据都可以。</p><p>Port Restricted Cone NAT 是记录外网主机的 IP 和端口，<strong>只有 (内网 IP, 内网端口) 和 (外网 IP, 外网端口) 这两个条件同时满足，数据才会转发给内网主机</strong>。而且以后给外部任何主机发送数据，都会用之前转换的 <code>(PublicIP:PublicPort)</code> 给外部主机发送数据。</p><p>也就是，内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，NAT 会为内部主机只分配一个 <code>(PublicIP:PublicPort)</code>，同时，也只有这 2 个 (RemoteIP:ReportPort) 可以给 (PublicIP: PublicPort) 发送数据（因为先由内向外发过）</p><h1 id=对称形-natsymmetric-nat>对称形 NAT（Symmetric NAT）
<span><a href=#%e5%af%b9%e7%a7%b0%e5%bd%a2-natsymmetric-nat><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>连接不同的外部目标，NAT 打开的端口不同。是一种「一对一映射关系」。</p><p>换句话讲，不同的 (iAddr:port, eAddr:port) 组合，NAT 网关会产生不同的链路。</p><p>看起来也就是对称的了。（本地地址:端口，目标地址:端口）</p><p>比如 <strong>localA</strong>:8000 经过一台拥有 <strong>global</strong> 的一台对称 NAT 的 Gateway，访问 <strong>baidu</strong>:80 和 <strong>google</strong>:80，</p><p>baidu 看到的可能是来自 <strong>global</strong>:5003 的请求，google 看到的可能是来自 <strong>global</strong>:5010 的请求。</p><p>打个比方，当内部主机以相同的 (LocalIP:LocalPort) 对 2 个不同的 (RemoteIP:RemotePort) 发送 UDP 报文时，此时 NAT 将会为内部主机分配<strong>两个不同的</strong> <code>(PublicIP:PublicPort)</code>，并且建立起<strong>两个不同的内、外部 Tuple 转换关系</strong>。</p><h1 id=symmetric-和-port-restricted-的区别>Symmetric 和 Port Restricted 的区别
<span><a href=#symmetric-%e5%92%8c-port-restricted-%e7%9a%84%e5%8c%ba%e5%88%ab><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p><strong>Port Restricted:</strong>
<img src=port-restricted.png alt=drawing width=400></p><ul><li>一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</li></ul><p><strong>Symmetric:</strong>
<img src=symmetric.png alt=drawing width=400></p><ul><li>每一个来自相同内部 IP 与端口，到一个特定目的地 IP 和端口的请求，都映射到一个独特的外部 IP 和端口。</li></ul><h1 id=reference>Reference
<span><a href=#reference><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p><a href=https://evilpan.com/2015/10/31/p2p-over-middle-box/>[1] P2P 通信原理与实现</a></p><p><a href=https://zhuanlan.zhihu.com/p/136794983>[2] 网络之 NAT 和 N2N VPN</a></p><p><a href=https://www.cnblogs.com/my_life/articles/11018457.html>[3] NAT 的四种类型及类型检测 2【很好】</a></p><p><a href=https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2>[4] 网络地址转换 - Wikipedia</a></p></div><div class=post-info><div class="post-date dt-published"><a class=u-url href=/posts/p2p/><time datetime=2020-06-26>2020-06-26</time></a></div><a class="post-hidden-url u-url" href=https://www.junyi.dev/posts/p2p/>https://www.junyi.dev/posts/p2p/</a>
<a href=https://www.junyi.dev/ class="p-name p-author post-hidden-author h-card" rel=me>Junyi Hou</a><div class=post-taxonomies><ul class=post-tags><li><a href=https://www.junyi.dev/tags/p2p/>#P2P</a></li><li><a href>#技术文章</a></li></ul></div></div></article></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>© Junyi Hou, 2023<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div></div><p class="h-card vcard"><a href=https://www.junyi.dev/ class="p-name u-url url fn" rel=me>Junyi Hou</a>
/
<a class="p-email u-email email" rel=me href=mailto:hhh@u.nus.edu>hhh@u.nus.edu</a></p></footer></div></body></html>